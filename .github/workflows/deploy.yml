name: CI/CD Pipeline

on:
  push:
    branches:
      - main

jobs:
  deploy_k8s:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y gettext jq

      - name: Set up kubectl
        uses: azure/setup-kubectl@v1
        with:
          version: 'latest'
      - name: Install Terraform
        uses: hashicorp/setup-terraform@v1
        with:
          terraform_version: 'latest'  # or specify a version like '1.3.0'
  
      - name: Authenticate to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
     
      - name: Set up Azure credentials
        run: |
          echo "Setting environment variables from Azure credentials"
          echo "${{ secrets.AZURE_CREDENTIALS }}" | jq -r '
            [
              "client_id=\(.clientId)",
              "client_secret=\(.clientSecret)",
              "tenant_id=\(.tenantId)",
              "subscription_id=\(.subscriptionId)"
            ] | .[]' >> $GITHUB_ENV 
                  
      - name: Initialize Terraform
        run: |
          cd terraform
          terraform init 
        
      - name: Terraform Plan
        run: |
          cd terraform
          terraform plan 
                         
      - name: Terraform Apply
        run: |
          cd terraform
          terraform apply -auto-approve 